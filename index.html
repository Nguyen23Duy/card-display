<!doctype html>
<meta charset="utf-8">
<title>Git Data API Debug</title>
<style>
  body{margin:0;font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto; background:#111; color:#eee}
  .row{display:grid;grid-template-columns:1fr 1fr; gap:12px; padding:12px}
  pre{background:#1a1a1a; color:#ddd; padding:10px; border-radius:8px; overflow:auto; max-height:40vh}
  button{padding:8px 12px; border-radius:8px; border:1px solid #444; background:#222; color:#fff; cursor:pointer}
  .ok{color:#8ef18e} .err{color:#ff8a8a}
  img{max-width:40vw; max-height:40vh; background:#000; border:1px solid #333; border-radius:8px}
  .bar{padding:12px; display:flex; gap:10px; align-items:center}
  input{background:#1b1b1b; color:#fff; border:1px solid #333; border-radius:6px; padding:6px 8px; width:240px}
  label{opacity:.8}
</style>
<div class="bar">
  <label>Owner <input id="owner" value="Nguyen23Duy"></label>
  <label>Repo <input id="repo" value="card-display"></label>
  <label>Branch <input id="branch" value="uploads"></label>
  <label>Path <input id="path" value="latest.png"></label>
  <button id="run">RUN</button>
</div>

<div class="row">
  <div>
    <h3>1) refs/heads/&lt;branch&gt;</h3>
    <div id="refStatus"></div>
    <pre id="refOut"></pre>
  </div>
  <div>
    <h3>2) trees/&lt;headSHA&gt;?recursive=1</h3>
    <div id="treeStatus"></div>
    <pre id="treeOut"></pre>
  </div>
</div>

<div class="row">
  <div>
    <h3>3) blob &lt;blobSHA&gt;</h3>
    <div id="blobStatus"></div>
    <pre id="blobOut"></pre>
  </div>
  <div>
    <h3>Preview</h3>
    <img id="preview" alt="(image preview)">
  </div>
</div>

<script>
const refStatus = s=>document.getElementById('refStatus').innerHTML=s;
const treeStatus = s=>document.getElementById('treeStatus').innerHTML=s;
const blobStatus = s=>document.getElementById('blobStatus').innerHTML=s;
const refOut = s=>document.getElementById('refOut').textContent=s;
const treeOut = s=>document.getElementById('treeOut').textContent=s;
const blobOut = s=>document.getElementById('blobOut').textContent=s;

async function fetchTxt(url){
  const r = await fetch(url + (url.includes('?')?'&':'?') + '_ts=' + Date.now(), {cache:'no-store'});
  const t = await r.text();
  return {ok:r.ok, status:r.status, text:t};
}

async function run() {
  const OWNER = document.getElementById('owner').value.trim();
  const REPO = document.getElementById('repo').value.trim();
  const BRANCH = document.getElementById('branch').value.trim();
  const PATH = document.getElementById('path').value.trim();
  const API = `https://api.github.com/repos/${OWNER}/${REPO}/git`;

  document.getElementById('preview').src = '';
  refStatus(''); treeStatus(''); blobStatus('');
  refOut(''); treeOut(''); blobOut('');

  // 1) refs
  const r1 = await fetchTxt(`${API}/refs/heads/${encodeURIComponent(BRANCH)}`);
  refOut(r1.text);
  refStatus(r1.ok ? `<span class="ok">OK ${r1.status}</span>` : `<span class="err">ERR ${r1.status}</span>`);
  if (!r1.ok) return;
  let headSHA;
  try { headSHA = JSON.parse(r1.text).object.sha; } catch(e){ refStatus(`<span class="err">Bad JSON</span>`); return; }

  // 2) tree
  const r2 = await fetchTxt(`${API}/trees/${headSHA}?recursive=1`);
  treeOut(r2.text);
  treeStatus(r2.ok ? `<span class="ok">OK ${r2.status}</span>` : `<span class="err">ERR ${r2.status}</span>`);
  if (!r2.ok) return;
  let blobSHA = null;
  try {
    const obj = JSON.parse(r2.text);
    const hit = (obj.tree||[]).find(e=>e.type==='blob' && e.path===PATH);
    blobSHA = hit && hit.sha;
  } catch(e){ treeStatus(`<span class="err">Bad JSON</span>`); return; }
  if (!blobSHA){ treeStatus(`<span class="err">Không thấy ${PATH} trong tree</span>`); return; }

  // 3) blob
  const r3 = await fetchTxt(`${API}/blobs/${blobSHA}`);
  blobOut(r3.text);
  blobStatus(r3.ok ? `<span class="ok">OK ${r3.status}</span>` : `<span class="err">ERR ${r3.status}</span>`);
  if (!r3.ok) return;
  let b64;
  try { b64 = JSON.parse(r3.text).content.replace(/\n/g,''); } catch(e){ blobStatus(`<span class="err">Bad JSON</span>`); return; }
  document.getElementById('preview').src = `data:image/png;base64,${b64}`;
}

document.getElementById('run').addEventListener('click', run);
run();
const OWNER="Nguyen23Duy", REPO="card-display", BRANCH="uploads", FILE="latest.png";

async function showNewest() {
  // 1) Lấy commit mới nhất có chạm FILE trên BRANCH
  const commitsUrl = `https://api.github.com/repos/${OWNER}/${REPO}/commits?path=${encodeURIComponent(FILE)}&sha=${encodeURIComponent(BRANCH)}&per_page=1`;
  const r = await fetch(commitsUrl, {cache:"no-store"});
  const arr = await r.json();
  const sha = arr[0]?.sha;
  if (!sha) { console.error("Không lấy được SHA"); return; }

  // 2) Load đúng file ở SHA đó (bypass cache)
  const raw = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${sha}/${FILE}`;
  document.getElementById("card").src = raw;
  document.getElementById("meta").textContent = `Commit: ${sha.slice(0,7)}…`;
}
</script>
